Ниже представлен детальный документ требований (PRD) для первой итерации фотопортфолио-сайта.

---

## 1. Цели и задачи

* **Основная цель:** предоставить фотографам возможность загружать и делиться галереями по автоматически генерируемым ссылкам с настраиваемым временем жизни.
* **Задачи:**

  1. Загрузка фотографий через личный кабинет.
  2. Генерация уникальных (UUID‑похожих) ссылок, опционально с истечением срока действия.
  3. Просмотр галереи и отдельной фотографии по ссылке без авторизации.
  4. Скачивание одной фотографии или всего набора в ZIP “на лету”.
  5. Подсчёт просмотров и скачиваний (агрегированные метрики).

---

## 2. Стейкхолдеры

* **Фотографы** – владельцы галерей, загружают и управляют ссылками.
* **Гости** – просматривают галереи и скачивают фотографии.
* **DevOps / Администраторы** – настраивают и поддерживают инфраструктуру.

---

## 3. Область (Scope)

### Включено в первую итерацию

* Регистрация и вход фотографа (FastAPI + JWT).
* Загрузка фотографий (ограничение 15 МБ на файл).
* Хранение файлов в S3‑совместимом хранилище (в проде – настоящие S3, в dev – MinIO).
* Генерация и хранение ссылок с UUID и опциональным временем истечения (nullable).
* Публичный просмотр галереи и одиночной фотографии (адаптивный фронтенд).
* Скачивание ZIP архива и отдельных файлов “на лету”.
* Логирование и подсчёт:

  * просмотры галереи (по заходам на URL);
  * скачивания (ZIP / одиночный).

### Исключено (потом)

* Система паролей для ссылок.
* “Человеко­читаемые” алиасы.
* Ограничения по объёму хранения.
* Детальная статистика по отдельным фотографиям.

---

## 4. Пользовательские истории

| ID  | Роль     | История                                                                                      | Критерии приёмки                                       |
| --- | -------- | -------------------------------------------------------------------------------------------- | ------------------------------------------------------ |
| US1 | Фотограф | Как фотограф, я хочу зарегистрироваться и войти в личный кабинет, чтобы управлять галереями. | Форма регистрации/входа; JWT‑сессия; защита роутов.    |
| US2 | Фотограф | Как фотограф, я хочу загрузить фотографии (≤ 15 МБ), чтобы собрать галерею.                  | Успешная загрузка в S3; в БД — запись с URL файла.     |
| US3 | Фотограф | Как фотограф, я хочу сгенерировать ссылку (UUID) с опциональным сроком жизни.                | Генерация UUID; хранение expires\_at nullable.         |
| US4 | Гость    | Как гость, я хочу открыть публичную ссылку и увидеть все фото в виде адаптивной сетки.       | Сетка thumbnail; адаптив под мобилу; без логина.       |
| US5 | Гость    | Как гость, я хочу кликнуть на фотографию и увидеть её в полном размере.                      | Lightbox / fullscreen-view.                            |
| US6 | Гость    | Как гость, я хочу скачать одну фотографию или все разом в ZIP.                               | Кнопки “Скачать фото” и “Скачать все”; ZIP on‑the‑fly. |
| US7 | Система  | Как админ, я хочу видеть счётчики просмотров и скачиваний в БД.                              | Поля counters: `views`, `zip_downloads`, `single_dl`.  |

---

## 5. Функциональные требования

### 5.1. Аутентификация

* Стек: FastAPI, **Python 3.13**, OAuth2 Password (JWT).
* Роуты: `/auth/register`, `/auth/login`, `/auth/refresh`.

### 5.2. Управление галереями и ссылками

* **Модель Gallery**

  * `id: UUID`
  * `owner_id: UUID` → User
  * `created_at, updated_at`
* **Модель Photo**

  * `id: UUID`
  * `gallery_id: UUID`
  * `url_s3: str`
  * `file_size: int`
  * `uploaded_at: datetime`
* **Модель ShareLink**

  * `id: UUID`
  * `gallery_id: UUID`
  * `expires_at: datetime | null`
  * `views: int`
  * `zip_downloads: int`
  * `single_downloads: int`

### 5.3. Загрузка и хранение

* Загрузка: POST `/galleries/{gallery_id}/photos` (multipart/form-data).
* Хранение: boto3 + настройка на S3/MinIO.

### 5.4. Публичный просмотр

* GET `/s/{share_id}` → возвращает JSON со списком URL превью (thumbnails создаются бекендом и хранятся в кеше Redis).
* GET `/s/{share_id}/photos/{photo_id}` → полный размер.

### 5.5. Скачивание

* GET `/s/{share_id}/download/all` → StreamingResponse ZIP.
* GET `/s/{share_id}/download/{photo_id}` → StreamingResponse файла.
* Каждый эндпоинт инкрементирует соответствующий счётчик.

---

## 6. Нефункциональные требования

* **Производительность:**

  * Время генерации ZIP < 5 с при 50 фотографиях.
* **Безопасность:**

  * Валидация JWT, проверка `expires_at`.
  * Ограничение размера загрузок (15 МБ).
  * Ограничение типов файлов (только JPG, JPEG, PNG) в том числе по "магическим байтам".
* **Масштабируемость:**

  * Статeless FastAPI, горизонтальное масштабирование.
  * S3 для файлов.

---

## 7. Техническая архитектура

```plaintext
┌──────────────┐      HTTPS       ┌─────────────────┐      S3 API      ┌────────────┐
│   Фронтенд   │◀────────────────▶│   FastAPI App   │◀────────────────▶│   S3/MinIO │
│ (React/Vue)  │                  │ (Python 3.13)   │                  │            │
└──────────────┘                  └────────┬────────┘                  └────────────┘
                                           │
                                           │ PostgreSQL (SQLAlchemy, Alembic)
                                           ▼
                                  ┌─────────────┐
                                  │ База Данных │
                                  └─────────────┘

```

---

## 8. Схема БД (ERD)

```mermaid
erDiagram
    users        ||--o{ galleries     : owns
    galleries    ||--o{ photos        : contains
    galleries    ||--o{ share_links   : exposes
    share_links  }o--o{ download_logs  : tracks

    users {
      UUID    id PK
      String  email
      String  password_hash
    }
    galleries {
      UUID    id PK
      UUID    owner_id FK
      DateTime created_at
    }
    photos {
      UUID    id PK
      UUID    gallery_id FK
      String  url_s3
      Int     file_size
      DateTime uploaded_at
    }
    share_links {
      UUID      id PK
      UUID      gallery_id FK
      DateTime? expires_at
      Int       views
      Int       zip_downloads
      Int       single_downloads
    }
```

---

## 9. API-эндпоинты

| Метод | Путь                                | Описание                 | Auth       |
| ----- | ----------------------------------- | ------------------------ | ---------- |
| POST  | `/auth/register`                    | Регистрация фотографа    | —          |
| POST  | `/auth/login`                       | Вход, получение JWT      | —          |
| GET   | `/galleries`                        | Список галерей фотографа | Bearer JWT |
| POST  | `/galleries`                        | Создать галерею          | Bearer JWT |
| POST  | `/galleries/{id}/photos`            | Загрузить фото (≤ 15 МБ) | Bearer JWT |
| POST  | `/galleries/{id}/share-links`       | Сгенерировать ссылку     | Bearer JWT |
| GET   | `/s/{share_id}`                     | Получить список превью   | Public     |
| GET   | `/s/{share_id}/photos/{photo_id}`   | Получить оригинал фото   | Public     |
| GET   | `/s/{share_id}/download/all`        | Скачать ZIP всех фото    | Public     |
| GET   | `/s/{share_id}/download/{photo_id}` | Скачать одну фотографию  | Public     |

---

## 10. UX/UI (кратко)

* Главная страница личного кабинета: список галерей с кнопками “Загрузить фото”, “Сгенерировать ссылку”.
* Галерея: адаптивная grid‑layout (CSS Grid / Flexbox), lightbox при клике.
* Панель управления ссылками: показывает UUID, expires\_at, счётчики.

---

## 11. Roadmap и сроки

| Этап                     | Задачи                                                              | Оценка |
| ------------------------ | ------------------------------------------------------------------- | ------ |
| **Sprint 1 (2 нед.)**    | Аутентификация, модели User/Gallery, базовая страница кабинета      | 10 дн. |
| **Sprint 2 (2 нед.)**    | Загрузка фото в S3/MinIO, модели Photo, просмотр галереи (API + UI) | 10 дн. |
| **Sprint 3 (2 нед.)**    | Генерация ссылок, публичный просмотр, счётчики                      | 10 дн. |
| **Sprint 4 (2 нед.)**    | Реализация ZIP‑скачивания, подсчёт скачиваний, тесты                | 10 дн. |
| **Buffer & QA (1 нед.)** | Документация, интеграционные и нагрузочные тесты                    | 5 дн.  |

---

## 12. Риски и доп.замечания

* ZIP‑архивация “на лету” может быть тяжёлой при большом кол-ве снимков — продумать лимиты и очереди.
* Необходим мониторинг расхода S3 и бандвида.
* В следующих итерациях — защита ссылок паролем, лимиты хранения, “человеко­читаемые” ссылки.
