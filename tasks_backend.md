Ниже приведён подробный набор задач (беклог) для реализации MVP. Каждая задача описана с ожидаемым результатом и критериями готовности.

На каждый созданный эндпоинт необходимо написать тесты, которые проверяют корректность работы и обработку ошибок. Тесты должны покрывать как положительные, так и отрицательные сценарии. Используйте `pytest` для написания тестов.

---
## Epic 0. Инициализация проекта и инфраструктура
| №   | Задача                               | Описание                                                                      | Критерии готовности                        |
| --- | ------------------------------------ | ----------------------------------------------------------------------------- | ------------------------------------------ |
| 0.1 | Структура проекта в src layout      | Создать базовую структуру проекта с папками для приложения, тестов и конфигурации. | Структура создана, папки соответствуют стандартам. |
| 0.2 | Docker-образ приложения              | Dockerfile для FastAPI, на базе Python 3.13, с запуском Uvicorn.              | Собирается без ошибок, контейнер стартует. |
| 0.3 | Docker-компоновка с MinIO и Postgres | Создать `docker-compose.yml`: сервисы `app`, `minio`, `postgres`; сети; тома. | Все сервисы поднимаются и связываются.     |
| 0.4 | Настройка окружения                  | Создать `.env` с переменными для подключения к БД, MinIO, секретами.          | Файл существует, переменные корректны.     |
| 0.5 | Линтеры и форматирование             | Настроить `pre-commit` с `ruff`, `mypy`, `black` для проверки кода.           | Все проверки проходят, код отформатирован. |



## Epic 1. Аутентификация и управление пользователями

| №   | Задача                            | Описание                                                                                                                  | Критерии готовности                                         |
| --- | --------------------------------- | ------------------------------------------------------------------------------------------------------------------------- | ----------------------------------------------------------- |
| 1.1 | Создать модели User и миграции БД | Реализовать модель `User` (поле `id`, `email`, `password_hash`, `created_at`) с помощью SQLAlchemy и Alembic.             | Миграции проходят без ошибок, таблица создана.              |
| 1.2 | Реализовать эндпоинт регистрации  | POST `/auth/register`: принимает email и пароль, валидирует, хеширует пароль, сохраняет нового пользователя.              | При валидном запросе возвращает 201 и JSON с `user.id`.     |
| 1.3 | Реализовать эндпоинт логина       | POST `/auth/login`: принимает email и пароль, проверяет, возвращает JWT access/refresh.                                   | При верных учётках — 200 и токены; при неверных — 401.      |
| 1.4 | Middleware для проверки JWT       | Добавить зависимость для защищённых роутов, декоратор/Depends, проверяющий валидность JWT и подставляющий `current_user`. | Попытка доступа без/с битым токеном — 401; с валидным — OK. |

---

## Epic 2. Управление галереями

| №   | Задача                    | Описание                                                                         | Критерии готовности                                        |
| --- | ------------------------- | -------------------------------------------------------------------------------- | ---------------------------------------------------------- |
| 2.1 | Модель Gallery и миграции | Создать модель `Gallery` (`id: UUID`, `owner_id: UUID FK → User`, `created_at`). | Миграция выполнена, FK связь с `users` корректна.          |
| 2.2 | Эндпоинт создания галереи | POST `/galleries`: создаёт пустую галерею для залогиненного пользователя.        | Возвращает `201` с JSON-объектом галереи.                  |
| 2.3 | Эндпоинт списка галерей   | GET `/galleries`: возвращает список галерей текущего пользователя.               | Список соответствует записям в БД; поддерживает пагинацию. |

---

## Epic 3. Загрузка и хранение фотографий

| №   | Задача                   | Описание                                                                                                                 | Критерии готовности                                       |
| --- | ------------------------ | ------------------------------------------------------------------------------------------------------------------------ | --------------------------------------------------------- |
| 3.1 | Модель Photo и миграции  | Создать модель `Photo` (`id: UUID`, `gallery_id: UUID FK`, `url_s3`, `file_size`, `uploaded_at`).                        | Миграция успешна, FK связь с `galleries` корректна.       |
| 3.2 | Интеграция с S3/MinIO    | Настроить `boto3` для работы с S3: конфигурация endpoint, ключи, бакет; локально — MinIO.                                | По команде from app можно залить и скачать тестовый файл. |
| 3.3 | Эндпоинт загрузки фото   | POST `/galleries/{gallery_id}/photos`: multipart upload, проверка размера ≤ 15 МБ, заливка в S3, сохранение записи в БД. | Успешная загрузка возвращает `201` и метаданные фото.     |
| 3.4 | Валидация размера файлов | В middleware или внутри обработки загрузки отсекаются файлы свыше 15 МБ с ошибкой 413.                                   | При слишком большом файле — 413 Payload Too Large.        |

---

## Epic 4. Генерация и хранение ссылок

| №   | Задача                      | Описание                                                                                                      | Критерии готовности                                     |
| --- | --------------------------- | ------------------------------------------------------------------------------------------------------------- | ------------------------------------------------------- |
| 4.1 | Модель ShareLink и миграции | Создать модель `ShareLink` (`id: UUID`, `gallery_id: UUID FK`, `expires_at: DateTime nullable`, счётчики).    | Миграция успешна; поля существуют и nullable.           |
| 4.2 | Эндпоинт генерации ссылки   | POST `/galleries/{gallery_id}/share-links`: создаёт новую ссылку с `expires_at` из тела запроса (или `null`). | Возвращает `201` с объектом `{ share_id, expires_at }`. |
| 4.3 | Проверка срока жизни ссылок | Middleware/декоратор для публичных роутов. При `expires_at` в прошлом — 404.                                  | Для просроченной ссылки возвращается 404 Not Found.     |

---

## Epic 5. Публичный просмотр

| №   | Задача                         | Описание                                                                                 | Критерии готовности                                              |
| --- | ------------------------------ | ---------------------------------------------------------------------------------------- | ---------------------------------------------------------------- |
| 5.1 | Эндпоинт списка фото по ссылке | GET `/s/{share_id}`: возвращает JSON с массивом `{ photo_id, thumbnail_url, full_url }`. | Корректный список для валидной ссылки, `expires_at` учтён.       |
| 5.2 | Эндпоинт просмотра одного фото | GET `/s/{share_id}/photos/{photo_id}`: возвращает redirect/streaming full\_url.          | Для валидного `photo_id` отдает файл, для несуществующего — 404. |
| 5.3 | Инкремент счётчика просмотров  | В обработке GET `/s/{share_id}` — увеличивать `views` в `ShareLink`.                     | После запроса значение `views` выросло на единицу.               |

---

## Epic 6. Скачивание фотографий

| №   | Задача                               | Описание                                                                                                           | Критерии готовности                                   |
| --- | ------------------------------------ | ------------------------------------------------------------------------------------------------------------------ | ----------------------------------------------------- |
| 6.1 | Скачивание отдельной фото            | GET `/s/{share_id}/download/{photo_id}`: стриминг файла из S3 и инкремент `single_downloads`.                      | Файл скачивается, счётчик увеличен на 1.              |
| 6.2 | Скачивание всех фото в ZIP “на лету” | GET `/s/{share_id}/download/all`: собирает в ZIP каждый файл из галереи, стримит архив, инкремент `zip_downloads`. | Браузер начинает скачивание архива, счётчик увеличен. |
| 6.3 | Тест нагрузки ZIP-генерации          | Написать интеграционный тест: 50 небольших JPG в одном запросе ZIP <5 с.                                           | Тест проходит за требуемое время.                     |

---

## Epic 7. Статистика и мониторинг

| №   | Задача                             | Описание                                                                                       | Критерии готовности                                |
| --- | ---------------------------------- | ---------------------------------------------------------------------------------------------- | -------------------------------------------------- |
| 7.1 | Миграции для счётчиков             | Поля `views`, `zip_downloads`, `single_downloads` в `ShareLink` (если не сделано ранее).       | Поля присутствуют, инициализируются нулём.         |
| 7.2 | Экспонирование метрик в Prometheus | Собрать и отдать метрики FastAPI: общее число запросов, ошибки 4xx/5xx, время ответа.          | Показаны в `/metrics`, Grafana отображает дашборд. |
| 7.3 | Логирование операций               | Включить StructuredLogger (Uvicorn), логировать Upload/Download/Error с контекстом `share_id`. | Логи сохраняются в JSON-файле или stdout.          |

---

## Epic 8. CI/CD

| 8.1 | CI-pipeline на GitHub Actions        | Прогоны линтера (flake8/isort), тестов (pytest), билд Docker.                        | PR-ы проходят все проверки автоматически.  |
| 8.2 | Настройка деплоя в staging           | Скрипт деплоя контейнеров на тестовый сервер (SSH/Ansible или Docker Hub + Compose). | После пуша в `main` деплоится staging.     |

---

### Итоговое примечание

Выполнение всех вышеописанных задач обеспечит работоспособный MVP, позволяющий фотографу:

1. Регаться и заходить в личный кабинет.
2. Создавать галереи и загружать фото.
3. Генерировать публичные ссылки с управлением сроком действия.
4. Делиться галереями и скачивать фото/архивы.
5. Видеть базовые метрики просмотров и скачиваний.

Дальнейшие улучшения (пароли, лимиты, “человеко­читаемые” ссылки, продвинутая аналитика) могут быть вынесены в последующие релизы.
